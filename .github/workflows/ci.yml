name: CI

on: [push, pull_request]

env:
    UV_SYSTEM_PYTHON: 1
    UV_PYTHON_DOWNLOADS: never
    UV_PYTHON_PREFERENCE: only-system

jobs:
    checks:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: astral-sh/ruff-action@v3

    test:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres
                env:
                    POSTGRES_PASSWORD: secret
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 3
                ports:
                    - 5432:5432
            mysql:
                image: mysql
                env:
                    MYSQL_ROOT_PASSWORD: secret
                options: >-
                    --health-cmd "mysqladmin ping --host=127.0.0.1"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 3
                ports:
                    - 3306:3306
        strategy:
            matrix:
                django-version: ["6.0"]
                python-version: ["3.12", "3.13", "3.13t", "3.14", "3.14t"]
        steps:
            - uses: actions/checkout@v6
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Setup uv
              uses: astral-sh/setup-uv@v7
            - name: Run Tests (SQLite)
              run: uv run --with "django~=${{ matrix.django-version }}" manage.py test
            - name: Run Tests (PostgreSQL)
              run: uv run --with "django~=${{ matrix.django-version }}" manage.py test
              env:
                  TEST_ENGINE: postgres
                  POSTGRES_PASSWORD: secret
            - name: Run Tests (MySQL)
              run: uv run --with "django~=${{ matrix.django-version }}" manage.py test
              env:
                  TEST_ENGINE: mysql
                  MYSQL_PASSWORD: secret
